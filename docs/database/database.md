# Базы данных (PostgresQ)

## БД индексы

PostgreSQL поддерживает несколько типов индексов: B-дерево, хеш, GiST, SP-GiST, GIN и BRIN. Для разных типов индексов применяются разные алгоритмы, ориентированные на определённые типы запросов. По 
умолчанию команда CREATE INDEX создаёт индексы типа B-дерево, эффективные в большинстве случаев.

https://datafinder.ru/products/postgresql-indeksy

https://postgrespro.ru/docs/postgresql/9.6/indexes-types

Подробно о всех индексах:

https://habr.com/ru/companies/postgrespro/articles/326096/

Советы:

- Если пишешь индекс по нескольким колонкам, то их очередность зависит от их селективности - самая первая: наиболее селективная (отражается на памяти занимаймым индексом). Но по хорошему надо смотреть на запросы

- Если есть много null - делай индекс с not null

- Если есть foreign key - лучше повесить на него индекс

- Плохо параллелить запросы в БД в OLTP, тк ты забираешь "ядро" которое могло также обрабатывать другой запрос

- Смотри статистику по индексу

Полезные команды:

1. Проверка статисктики с помощью pg_stat

```
SELECT * FROM pg_stat WHERE tablename = '<table_name>' and attname = '<column_name>'
```

2. Создание index'а

```
CREATE INDEX <index_name> ON <table_name>
(optinal) WHERE <column_name> ...;
```

3. Посмотреть статисктику выполения запроса:

```
EXPLAIN ANALYZE <запрос>
```

4. Посмотреть на индексы:

```
\d <table_name>
```


## ACID

#### Atomicity или атомарность (A)

В этой ситуации речь идет о проблеме потери данных. В целях снижения этого риска транзакции обладают таким свойством, как атомарность (atomicity), неделимость: либо будут выполнены все действия транзакции, либо никакие.

#### Consistency или согласованность (C)
Согласованность означает, что если до выполнения транзакции данные в БД находятся в неком состоянии «good state»*, то они будут в этом же состоянии и после выполнения транзакции.

*Иными словами, выполняется некий набор условий. Примеры: в таблице countries не должно быть двух строк с названием страны «Российская Федерация»; возраст человека не может быть больше 150 лет.

На самом деле ни одна база данных не может гарантировать свойство согласованности. А всё потому, что поддержание консистентности — это прерогатива приложения, а не БД. База данных лишь предоставляет инструменты для выполнения данного свойства транзакции, например, уникальные ключи, внешние ключи и т.д.

#### Isolation или изоляция (I)

Переходим к самому интересному свойству — изоляции. Представим ситуацию, когда в определенный момент времени с системой работают несколько пользователей. Естественно, операции транзакции в БД выполняются параллельно, чтобы ускорить работу системы. Но у параллельной работы транзакций есть свои подводные камни:

- Если операции транзакции взаимодействуют с разным набором непересекающихся данных, все работает корректно.  
- Но что будет, если две и более операций транзакции в один момент времени начнут работать с одним и тем же набором данных? Возникнет явление, называемое race condition (состояние гонки).

Выделяют несколько эффектов, связанных с этим явлением.

- **Эффект потерянного обновления** возникает, когда несколько транзакций обновляют одни и те же данные, не учитывая изменений, сделанных другими транзакциями.
- **Эффект грязного чтения** возникает, когда транзакция считывает данные, которые еще не были зафиксированы.
- **Эффект неповторяемого чтения** возникает, когда транзакция считывает дважды одну и ту же строку, но каждый раз получает разные результаты.
- **Эффект чтения фантомов** возникает, когда набор данных соответствует условиям поиска, но изначально не отображается.

##### Решение:

Для устранения данных эффектов на уровне баз данных предусмотрены уровни изоляции, или transaction isolation levels, которые так или иначе реализованы во многих СУБД.

#### Durability или долговечность (D)

Долговечность означает, что если транзакция выполнена, и даже если в следующий момент произойдет сбой в системе, результат сохранится.

https://habr.com/ru/companies/simbirsoft/articles/572540/

## Уровни изоляции

https://habr.com/ru/articles/317884/
